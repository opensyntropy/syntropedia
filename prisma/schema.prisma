// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  USER
  MODERATOR
  ADMIN
}

enum SpeciesStatus {
  RASCUNHO
  PUBLICADO
  EM_REVISAO
}

enum Estrato {
  EMERGENTE
  ALTO
  MEDIO
  BAIXO
  RASTEIRO
}

enum EstagioSucessional {
  PIONEIRA
  SECUNDARIA_INICIAL
  SECUNDARIA_TARDIA
  CLIMAX
}

enum CicloVida {
  ANUAL
  BIENAL
  PERENE_CURTA
  PERENE_MEDIA
  PERENE_LONGA
  CENTENARIA
}

enum FormatoCopa {
  CONICA
  PIRAMIDAL
  COLUNARE
  ARREDONDADA
  GLOBOSA
  OVAL
  IRREGULAR
  PENDENTE
  UMBELIFORME
  PALMEIRA
}

enum TipoFolhagem {
  PERENIFOLIA
  SEMIPERENIFOLIA
  CADUCIFOLIA
  SEMIDECIDUA
}

enum VelocidadeCrescimento {
  MUITO_RAPIDO
  RAPIDO
  MEDIO
  LENTO
  MUITO_LENTO
}

enum SistemaRadicular {
  PIVOTANTE
  FASCICULADO
  TUBEROSO
  ADVENTICIO
  PNEUMATOFORO
  ESCORA
  MISTO
}

enum ProducaoBiomassa {
  MUITO_ALTA
  ALTA
  MEDIA
  BAIXA
  MUITO_BAIXA
}

enum UsoPlanta {
  ALIMENTACAO_HUMANA
  ALIMENTACAO_ANIMAL
  MADEIRA
  MEDICINAL
  ORNAMENTAL
  CERCA_VIVA
  SOMBRA
  QUEBRA_VENTO
  COBERTURA_SOLO
  MEL
  FIBRA
  OLEO
  LENHA
  ARTESANATO
}

// Models
model User {
  id         String   @id @default(cuid())
  name       String
  email      String   @unique
  avatar     String?
  role       UserRole @default(USER)
  discourseId String? @unique @map("discourse_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  speciesCreated Species[]  @relation("SpeciesCreator")
  speciesUpdated Species[]  @relation("SpeciesUpdater")
  photos         Photo[]
  changeHistory  ChangeHistory[]

  @@map("users")
}

model Species {
  id             String           @id @default(cuid())
  slug           String           @unique

  // Nomenclatura
  nomeCientifico String           @map("nome_cientifico")
  genero         String?
  especie        String?
  autor          String?
  nomesPopulares String[]         @map("nomes_populares")
  sinonimos      String[]
  familiaBotanica String?         @map("familia_botanica")
  variedade      String?

  // Dados Base
  estrato              Estrato
  estagioSucessional   EstagioSucessional @map("estagio_sucessional")
  cicloVida            CicloVida?         @map("ciclo_vida")
  cicloVidaAnos        String?            @map("ciclo_vida_anos")
  alturaMetros         Decimal?           @map("altura_metros") @db.Decimal(5, 2)
  larguraCopaMetros    Decimal?           @map("largura_copa_metros") @db.Decimal(5, 2)
  formatoCopa          FormatoCopa?       @map("formato_copa")

  // Complementares
  centroOrigem         String?            @map("centro_origem")
  biomaGlobal          String?            @map("bioma_global")
  biomaRegional        String[]           @map("bioma_regional")
  tipoFolhagem         TipoFolhagem?      @map("tipo_folhagem")
  epocaQuedaFolhas     String?            @map("epoca_queda_folhas")
  velocidadeCrescimento VelocidadeCrescimento? @map("velocidade_crescimento")
  sistemaRadicular     SistemaRadicular?  @map("sistema_radicular")
  fixadoraNitrogenio   Boolean            @default(false) @map("fixadora_nitrogenio")
  producaoBiomassa     ProducaoBiomassa?  @map("producao_biomassa")
  temFruto             Boolean            @default(false) @map("tem_fruto")
  frutoComestivel      Boolean            @default(false) @map("fruto_comestivel")
  frutificacaoInicio   Int?               @map("frutificacao_inicio")
  frutificacaoFim      Int?               @map("frutificacao_fim")

  // Usos
  usos                 UsoPlanta[]

  // Propagação
  metodosPropagacao    String[]           @map("metodos_propagacao")

  // Outros
  observacoes          String?            @db.Text
  status               SpeciesStatus      @default(RASCUNHO)
  discourseTopicUrl    String?            @map("discourse_topic_url")

  // Metadados
  createdById    String   @map("created_by_id")
  createdBy      User     @relation("SpeciesCreator", fields: [createdById], references: [id])
  updatedById    String?  @map("updated_by_id")
  updatedBy      User?    @relation("SpeciesUpdater", fields: [updatedById], references: [id])
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  photos         Photo[]
  changeHistory  ChangeHistory[]

  @@map("species")
  @@index([slug])
  @@index([estrato])
  @@index([estagioSucessional])
  @@index([status])
  @@index([nomeCientifico])
}

model Photo {
  id          String   @id @default(cuid())
  url         String
  legenda     String?
  tags        String[]
  localizacao String?
  aprovada    Boolean  @default(false)
  principal   Boolean  @default(false)

  speciesId   String   @map("species_id")
  species     Species  @relation(fields: [speciesId], references: [id], onDelete: Cascade)

  uploadById  String   @map("upload_by_id")
  uploadBy    User     @relation(fields: [uploadById], references: [id])
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  @@map("photos")
  @@index([speciesId])
  @@index([aprovada])
}

model ChangeHistory {
  id               String   @id @default(cuid())
  camposAlterados  String   @map("campos_alterados")
  valorAnterior    Json     @map("valor_anterior")
  valorNovo        Json     @map("valor_novo")
  motivoAlteracao  String?  @map("motivo_alteracao")

  speciesId        String   @map("species_id")
  species          Species  @relation(fields: [speciesId], references: [id], onDelete: Cascade)

  alteradoPorId    String   @map("alterado_por_id")
  alteradoPor      User     @relation(fields: [alteradoPorId], references: [id])
  alteradoEm       DateTime @default(now()) @map("alterado_em")

  @@map("change_history")
  @@index([speciesId])
  @@index([alteradoEm])
}
